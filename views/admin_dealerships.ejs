<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <title>Gestión de Flota - Admin</title>
</head>

<body class="bg-light">

    <%- include('./barraNavegadora.ejs') %>

        <div class="container-fluid my-4">
            <div class="row">
                <div class="col-12 px-md-4">

                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2 class="text-dark">Gestión de Concesionarios</h2>
                        <button class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#modalNuevoConcesionario">
                            <i class="bi bi-plus-circle"></i> Añadir Concesionario
                        </button>
                    </div>


                    <div class="card shadow-sm">
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover table-striped mb-0 align-middle">
                                    <thead class="bg-dark text-white">
                                        <tr>
                                            <th>Nombre</th>
                                            <th>Ciudad</th>
                                            <th>Dirección</th>
                                            <th>Contacto</th>
                                            <th class="text-end">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% concesionarios.forEach(c=> { %>
                                            <tr data-id="<%= c.id_concesionario %>">
                                                <td>
                                                    <%= c.nombre %>
                                                </td>
                                                <td>
                                                    <%= c.ciudad %>
                                                <td>
                                                    <%= c.direccion %>
                                                </td>
                                                <td>
                                                    <%= c.telefono_contacto %>
                                                </td>
                                                <td class="text-end">
                                                    <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#modalEditarConcesionario"
                                                        data-id="<%= c.id_concesionario %>"
                                                        data-nombre="<%= c.nombre %>"
                                                        data-ciudad="<%= c.ciudad %>"
                                                        data-direccion="<%= c.direccion %>"
                                                        data-telefono="<%= c.telefono_contacto %>">
                                                        <i class="bi bi-pencil"></i>
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-danger btn-delete-dealership" data-id="<%= c.id_concesionario %>" data-nombre="<%= c.nombre %>" data-bs-toggle="modal" data-bs-target="#modalConfirmDelete">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                            <% }) %>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="modalNuevoConcesionario" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-md">
                <div class="modal-content">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title">Registrar un Concesionario</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                            aria-label="Close"></button>
                    </div>
                    <form action="/admin/dealerships/new" method="POST">
                        <div class="modal-body">
                            <div class="mb-3">
                                <label for="nombre" class="form-label">Nombre</label>
                                <input type="text" class="form-control" id="nombre" name="nombre"
                                    placeholder="Concesionario" />
                                <% if (errors && errors.nombre) { %>
                                    <div class="text-danger mt-1">
                                        <%= errors.nombre.msg %>
                                    </div>
                                    <% } %>
                            </div>

                            <div class="mb-3">
                                <label for="ciudad" class="form-label">Ciudad</label>
                                <input type="text" class="form-control" id="ciudad" name="ciudad"
                                    placeholder="Madrid" />
                                <% if (errors && errors.ciudad) { %>
                                    <div class="text-danger mt-1">
                                        <%= errors.ciudad.msg %>
                                    </div>
                                    <% } %>
                            </div>

                            <div class="mb-3">
                                <label for="direccion" class="form-label">Dirección</label>
                                <input type="text" class="form-control" id="direccion" name="direccion"
                                    placeholder="Calle Mayor 1" />
                                <% if (errors && errors.direccion) { %>
                                    <div class="text-danger mt-1">
                                        <%= errors.direccion.msg %>
                                    </div>
                                    <% } %>
                            </div>

                            <div class="mb-3">
                                <label for="telefonoContacto" class="form-label">Teléfono de
                                    Contacto</label>
                                <input type="tel" class="form-control" id="telefono" name="telefonoContacto"
                                    placeholder="966 56 56 56" />
                                <% if (errors && errors.telefonoContacto) { %>
                                    <div class="text-danger mt-1">
                                        <%= errors.telefonoContacto.msg %>
                                    </div>
                                    <% } %>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="submit" class="btn btn-success">Guardar Concesionario</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="modal fade" id="modalEditarConcesionario" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-md">
                <div class="modal-content">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title">Editar Concesionario</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                            aria-label="Close"></button>
                    </div>
                    <form id="formEditarConcesionario">
                        <div class="modal-body">
                            <div class="mb-3">
                                <label for="edit-nombre" class="form-label">Nuevo Nombre</label>
                                <input type="text" class="form-control" id="edit-nombre" name="nombre" />
                                <% if (errors && errors.nombre) { %>
                                    <div class="text-danger mt-1">
                                        <%= errors.nombre.msg %>
                                    </div>
                                    <% } %>
                            </div>

                            <div class="mb-3">
                                <label for="edit-ciudad" class="form-label">Nueva Ciudad</label>
                                <input type="text" class="form-control" id="edit-ciudad" name="ciudad" />
                                <% if (errors && errors.ciudad) { %>
                                    <div class="text-danger mt-1">
                                        <%= errors.ciudad.msg %>
                                    </div>
                                    <% } %>
                            </div>

                            <div class="mb-3">
                                <label for="edit-direccion" class="form-label">Nueva Dirección</label>
                                <input type="text" class="form-control" id="edit-direccion" name="direccion" />
                                <% if (errors && errors.direccion) { %>
                                    <div class="text-danger mt-1">
                                        <%= errors.direccion.msg %>
                                    </div>
                                    <% } %>
                            </div>

                            <div class="mb-3">
                                <label for="edit-telefono" class="form-label">Nuevo Teléfono</label>
                                <input type="tel" class="form-control" id="edit-telefono" name="telefonoContacto" />
                                <% if (errors && errors.telefonoContacto) { %>
                                    <div class="text-danger mt-1">
                                        <%= errors.telefonoContacto.msg %>
                                    </div>
                                    <% } %>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="submit" class="btn btn-success">Guardar Concesionario</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Delete confirmation modal -->
        <div class="modal fade" id="modalConfirmDelete" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-sm modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title">Confirmar Eliminación</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p>¿Estás seguro de que quieres eliminar el concesionario <strong id="delete-dealership-name"></strong>?</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" id="confirm-delete-btn" class="btn btn-danger">Eliminar</button>
                    </div>
                </div>
            </div>
        </div>

        <script src="/js/bootstrap.bundle.min.js"></script>

        <% if (openModal) { %>
            <script>
                document.addEventListener('DOMContentLoaded', function () {
                    var modalEl = document.getElementById('modalNuevoConcesionario');
                    if (modalEl) {
                        var modal = new bootstrap.Modal(modalEl);
                        modal.show();
                    }
                });
            </script>
        <% } %>

        <script>
            document.addEventListener('DOMContentLoaded', function () {
                var editModalEl = document.getElementById('modalEditarConcesionario');
                if (!editModalEl) return;

                editModalEl.addEventListener('show.bs.modal', function (event) {
                    var button = event.relatedTarget;
                    if (!button) return;

                    var id = button.getAttribute('data-id') || '';
                    var nombre = button.getAttribute('data-nombre') || '';
                    var ciudad = button.getAttribute('data-ciudad') || '';
                    var direccion = button.getAttribute('data-direccion') || '';
                    var telefono = button.getAttribute('data-telefono') || '';

                    var inputId = document.getElementById('edit-id');
                    var inputNombre = document.getElementById('edit-nombre');
                    var inputCiudad = document.getElementById('edit-ciudad');
                    var inputDireccion = document.getElementById('edit-direccion');
                    var inputTelefono = document.getElementById('edit-telefono');

                    if (inputId) inputId.value = id;
                    if (inputNombre) inputNombre.value = nombre;
                    if (inputCiudad) inputCiudad.value = ciudad;
                    if (inputDireccion) inputDireccion.value = direccion;
                    if (inputTelefono) inputTelefono.value = telefono;

                    // Set form action to include id so server receives the id in the URL
                    var editForm = document.getElementById('formEditarConcesionario');
                    if (editForm) {
                        // Use method-override query param so standard POST works if needed
                        editForm.action = '/admin/dealerships/' + encodeURIComponent(id);
                        editForm.method = 'POST';
                    }
                });
            });
            
            // Delete flow using confirmation modal
            document.addEventListener('DOMContentLoaded', function () {
                var confirmModalEl = document.getElementById('modalConfirmDelete');
                var confirmBtn = document.getElementById('confirm-delete-btn');
                var nameEl = document.getElementById('delete-dealership-name');
                if (!confirmModalEl || !confirmBtn) return;

                confirmModalEl.addEventListener('show.bs.modal', function (event) {
                    var button = event.relatedTarget; // Button that triggered the modal
                    if (!button) return;

                    var id = button.getAttribute('data-id') || '';
                    var nombre = button.getAttribute('data-nombre') || '';

                    // display name in modal
                    if (nameEl) nameEl.textContent = nombre;

                    // attach id to confirm button
                    confirmBtn.dataset.id = id;
                });

                confirmBtn.addEventListener('click', function () {
                    var id = this.dataset.id;
                    if (!id) return;
                    this.disabled = true;

                    fetch('/admin/dealerships/' + encodeURIComponent(id), {
                        method: 'DELETE',
                        headers: {
                            'Accept': 'application/json'
                        }
                    })
                    .then(function (res) {
                        if (res.ok) return res.json();
                        throw new Error('Error en la petición');
                    })
                    .then(function (data) {
                        if (data && data.success) {
                            if (data.redirect) {
                                // navigate to redirect url suggested by server
                                window.location.href = data.redirect;
                                return;
                            }
                        }
                    })
                });
            });
        </script>
</body>

</html>